<!DOCTYPE html>
<html lang="en" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Agent ML | Global Content Forge 3D</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800;900&display=swap" rel="stylesheet">
    <style>
      :root {
        --bg: #0c0a09;
        --card: rgba(31, 41, 55, 0.6);
        --text: #f9fafb;
        --muted: #a1a1aa;
        --border: rgba(55, 65, 81, 0.5);
        --primary: #10b981;
        --primary-600: #059669;
        --accent: #34d399;
        --shadow: 0 5px 30px rgba(16, 185, 129, 0.2);
      }
      .light {
        --bg: #f1f5f9;
        --card: rgba(255, 255, 255, 0.6);
        --text: #1e293b;
        --muted: #475569;
        --border: rgba(203, 213, 225, 0.7);
        --primary: #059669;
        --primary-600: #047857;
        --accent: #047857;
        --shadow: 0 5px 15px rgba(4, 120, 87, 0.1);
      }
      body {
        background-color: var(--bg);
        transition: background-color 0.5s;
        overflow-x: hidden;
        font-family: 'Inter', sans-serif;
      }
      #bg-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
      .main-content { position: relative; z-index: 1; }
      .glass-card {
        background-color: var(--card);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border: 1px solid var(--border);
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
        transition: transform 0.3s, border-color 0.3s, box-shadow 0.3s;
      }
      .glass-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 40px rgba(16, 185, 129, 0.3);
        border-color: rgba(16, 185, 129, 0.5);
      }
      .navbar-glass {
        background-color: rgba(12, 10, 9, 0.7);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        transition: transform 0.3s;
      }
      .navbar-glass:hover {
        transform: translateY(-2px);
      }
      .light .navbar-glass { background-color: rgba(241, 245, 249, 0.7); }
      .typewriter-cursor { 
        display: inline-block; 
        background-color: var(--primary); 
        width: 2px; 
        height: 1.2rem; 
        animation: blink 1s infinite; 
        vertical-align: middle;
      }
      @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
      .text-var-text { color: var(--text); }
      .text-var-muted { color: var(--muted); }
      .text-var-primary { color: var(--primary); }
      .bg-var-primary { background-color: var(--primary); }
      .btn-primary {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 0 15px rgba(16, 185, 129, 0.3);
      }
      .btn-primary:hover {
        background-color: var(--primary-600);
        box-shadow: 0 0 25px rgba(16, 185, 129, 0.5);
        transform: translateY(-2px) scale(1.03);
      }
      .nav-link {
        position: relative;
        transition: color 0.3s, transform 0.3s;
      }
      .nav-link:hover {
        color: var(--primary);
        transform: scale(1.1);
      }
      .nav-link.active {
        color: var(--primary);
        font-weight: 600;
      }
      .nav-link::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        width: 0;
        height: 2px;
        background: var(--primary);
        transition: width 0.3s;
      }
      .nav-link:hover::after {
        width: 100%;
      }
      .chat-container { max-height: calc(100vh - 320px); overflow-y: auto; }
      .chat-message { max-width: 80%; padding: 0.75rem 1rem; border-radius: 1rem; margin-bottom: 1rem; line-height: 1.6; transition: transform 0.3s; }
      .chat-message:hover { transform: translateY(-2px); }
      .user-message { background-color: var(--primary); color: #0c0a09; border-bottom-right-radius: 0.25rem; align-self: flex-end; }
      .bot-message { background-color: #1f2937; color: var(--text); border-bottom-left-radius: 0.25rem; align-self: flex-start; }
      .light .bot-message { background-color: #e2e8f0; }
      .chat-input-area { background: var(--bg); border-top: 1px solid var(--border); }
      .bot-response-card { background: #111827; border-radius: 0.5rem; border: 1px solid var(--border); transition: transform 0.3s; }
      .bot-response-card:hover { transform: translateY(-4px); }
      .light .bot-response-card { background: #eef2ff; }
      .lang-en { border-left: 4px solid #10b981; }
      .lang-es { border-left: 4px solid #f59e0b; }
      .lang-de { border-left: 4px solid #ef4444; }
      .lang-ja { border-left: 4px solid #3b82f6; }
      .rendered-content h1 { 
        font-size: 1.75rem; 
        font-weight: 800; 
        color: var(--primary); 
        margin: 1rem 0 0.5rem 0; 
      }
      .rendered-content h2 { 
        font-size: 1.25rem; 
        font-weight: 700; 
        color: var(--primary); 
        margin: 1.5rem 0 0.75rem 0; 
      }
      .rendered-content p { 
        margin: 0.75rem 0; 
        line-height: 1.6; 
      }
      .rendered-content br { display: block; margin: 0.5rem 0; }
      .rendered-content[contenteditable="true"]:focus {
        outline: 2px solid var(--primary);
        background: rgba(255, 255, 255, 0.05);
      }
      .progress-bar {
        height: 4px;
        background: var(--primary);
        transition: width 0.3s ease;
      }
      .summary-box {
        background: rgba(255, 255, 255, 0.05);
        padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
        transition: transform 0.3s;
      }
      .summary-box:hover {
        transform: translateY(-2px);
      }
      .language-pill {
        display: inline-block;
        padding: 0.5rem 1rem;
        margin: 0.25rem;
        border-radius: 1rem;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid var(--border);
        cursor: pointer;
        transition: all 0.3s;
      }
      .language-pill:hover {
        background: rgba(16, 185, 129, 0.2);
        transform: scale(1.05);
        border-color: var(--primary);
      }
      .language-pill.selected {
        background: var(--primary);
        color: #0c0a09;
        border-color: var(--primary-600);
      }
      .slider {
        -webkit-appearance: none;
        width: 100%;
        height: 6px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 3px;
        outline: none;
        transition: background 0.3s;
      }
      .slider:hover {
        background: rgba(16, 185, 129, 0.3);
      }
      .slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: var(--primary);
        cursor: pointer;
        box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        transition: transform 0.3s;
      }
      .slider::-webkit-slider-thumb:hover {
        transform: scale(1.2);
      }
      .history-sidebar {
        position: fixed;
        top: 80px;
        left: 0;
        height: calc(100vh - 80px);
        width: 320px;
        background-color: var(--card);
        backdrop-filter: blur(16px);
        border-right: 1px solid var(--border);
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        z-index: 10;
      }
      .history-sidebar.open {
        transform: translateX(0);
      }
      .history-sidebar-header {
        padding: 1rem;
        border-bottom: 1px solid var(--border);
      }
      .history-item {
        padding: 0.75rem 1rem;
        cursor: pointer;
        transition: background 0.3s;
      }
      .history-item:hover {
        background: rgba(16, 185, 129, 0.2);
      }
      .history-item.active {
        background: var(--primary);
        color: #0c0a09;
      }
      .toggle-history-btn {
        transition: all 0.3s;
      }
      .toggle-history-btn:hover {
        background-color: var(--primary-600);
        transform: scale(1.05);
      }
      @media (max-width: 768px) {
        .history-sidebar {
          width: 100%;
          max-width: 300px;
        }
      }
      .inspire-card, .community-card {
        cursor: pointer;
        transition: transform 0.3s, box-shadow 0.3s;
      }
      .inspire-card:hover, .community-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 40px rgba(16, 185, 129, 0.3);
      }
      .community-form {
        background: var(--card);
        backdrop-filter: blur(16px);
        border: 1px solid var(--border);
      }
      .fade-in {
        animation: fadeIn 0.5s ease-in-out;
      }
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      .history-loading {
        text-align: center;
        padding: 1rem;
        color: var(--muted);
      }
    </style>
  </head>
  <body class="text-var-text flex flex-col min-h-screen">
    <canvas id="bg-canvas"></canvas>
    <div class="main-content">
      <nav class="fixed top-0 left-0 right-0 z-50 navbar-glass border-b border-[rgba(55,65,81,0.5)]">
        <div class="container mx-auto flex justify-between items-center px-6 md:px-10 py-4">
          <a href="#" data-page="home" class="nav-link text-var-primary font-bold text-2xl tracking-tight">Content <span class="text-var-accent">Forge</span></a>
          <div class="hidden md:flex space-x-10 items-center text-sm font-medium">
            <a href="#" data-page="home" class="nav-link text-var-text hover:text-var-primary transition-colors duration-300">Home</a>
            <a href="#" data-page="inspire" class="nav-link text-var-text hover:text-var-primary transition-colors duration-300">Inspire</a>
            <a href="#" data-page="community" class="nav-link text-var-text hover:text-var-primary transition-colors duration-300">Community</a>
            <a href="#" data-page="create" class="nav-link text-var-text hover:text-var-primary transition-colors duration-300">Create</a>
            <button id="themeToggle" class="p-2 rounded-full text-var-primary transition-all duration-300" title="Toggle Theme">
              <span id="sunIcon" class="hidden">☀️</span><span id="moonIcon" class="">🌙</span>
            </button>
          </div>
          <div class="md:hidden flex items-center"><button id="menuBtn" class="text-var-text focus:outline-none text-2xl">☰</button></div>
        </div>
        <div id="mobileMenu" class="hidden md:hidden px-6 pb-4 space-y-2 glass-card border-t border-[rgba(55,65,81,0.5)]">
          <a href="#" data-page="home" class="nav-link-mobile block py-2">Home</a>
          <a href="#" data-page="inspire" class="nav-link-mobile block py-2">Inspire</a>
          <a href="#" data-page="community" class="nav-link-mobile block py-2">Community</a>
          <a href="#" data-page="create" class="nav-link-mobile block py-2">Create</a>
        </div>
      </nav>
      <main>
        <div id="page-home" class="page-content">
          <section class="min-h-screen flex items-center justify-center text-center px-6">
            <div>
              <h1 class="text-5xl md:text-8xl font-black mb-6 leading-tight text-transparent bg-clip-text bg-gradient-to-r from-white via-emerald-200 to-emerald-400">The Digital Content Forge</h1>
              <p class="text-xl md:text-2xl mb-12 text-var-muted max-w-4xl mx-auto">Craft culturally resonant content with advanced AI, tailored for your audience.</p>
              <a href="#" data-page="create" class="nav-link inline-block bg-var-primary text-slate-900 px-10 py-4 rounded-lg font-bold uppercase tracking-wider btn-primary">Enter The Forge →</a>
            </div>
          </section>
        </div>

        <div id="page-create" class="page-content hidden">
          <section class="min-h-screen flex flex-col justify-between pt-20">
            <div class="container mx-auto px-6 w-full max-w-5xl flex-grow flex">
              <div id="history-sidebar" class="history-sidebar">
                <div class="history-sidebar-header flex justify-between items-center">
                  <h2 class="text-xl font-bold text-var-text">Content Archives</h2>
                  <button id="toggle-history" class="toggle-history-btn bg-var-primary text-slate-900 px-3 py-1 rounded-lg text-sm btn-primary">Close</button>
                </div>
                <div id="history-list" class="overflow-y-auto h-full p-4">
                  <div id="history-empty" class="text-center hidden">
                    <p class="text-var-muted">The Archives are currently empty. Forged content will appear here.</p>
                  </div>
                  <div id="history-loading" class="history-loading">Loading history...</div>
                  <div class="history-item rounded-lg">
                    <div>
                      <p class="text-sm font-semibold text-var-text mb-1">AI in marketing strategies</p>
                      <div class="mb-1">
                        <span class="inline-block bg-gray-700 text-gray-300 text-xs font-semibold mr-1 px-2 py-0.5 rounded-full">en</span>
                        <span class="inline-block bg-gray-700 text-gray-300 text-xs font-semibold mr-1 px-2 py-0.5 rounded-full">professional</span>
                        <span class="inline-block bg-gray-700 text-gray-300 text-xs font-semibold px-2 py-0.5 rounded-full">v1.0</span>
                      </div>
                      <div class="text-right mt-2">
                        <button class="text-xs text-var-primary hover:underline view-content" data-content="AI%20in%20Marketing%3Ch1%3EAI%20in%20Marketing%3C%2Fh1%3E%3Cp%3EArtificial%20intelligence%20is%20revolutionizing%20marketing...%3C%2Fp%3E" data-blogid="1" data-language="en">View</button>
                        <button class="text-xs text-var-primary hover:underline compare-versions ml-2" data-brief="AI in marketing strategies">Compare</button>
                      </div>
                    </div>
                  </div>
                  <div class="history-item rounded-lg">
                    <div>
                      <p class="text-sm font-semibold text-var-text mb-1">Sustainable business practices</p>
                      <div class="mb-1">
                        <span class="inline-block bg-gray-700 text-gray-300 text-xs font-semibold mr-1 px-2 py-0.5 rounded-full">es</span>
                        <span class="inline-block bg-gray-700 text-gray-300 text-xs font-semibold mr-1 px-2 py-0.5 rounded-full">friendly</span>
                        <span class="inline-block bg-gray-700 text-gray-300 text-xs font-semibold px-2 py-0.5 rounded-full">v1.1</span>
                      </div>
                      <div class="text-right mt-2">
                        <button class="text-xs text-var-primary hover:underline view-content" data-content="Pr%C3%A1cticas%20Empresariales%20Sostenibles%3Ch1%3EPr%C3%A1cticas%20Empresariales%20Sostenibles%3C%2Fh1%3E%3Cp%3ELas%20empresas%20adoptan%20estrategias%20verdes...%3C%2Fp%3E" data-blogid="2" data-language="es">View</button>
                        <button class="text-xs text-var-primary hover:underline compare-versions ml-2" data-brief="Sustainable business practices">Compare</button>
                      </div>
                    </div>
                  </div>
                  <div class="history-item rounded-lg">
                    <div>
                      <p class="text-sm font-semibold text-var-text mb-1">Remote work culture trends</p>
                      <div class="mb-1">
                        <span class="inline-block bg-gray-700 text-gray-300 text-xs font-semibold mr-1 px-2 py-0.5 rounded-full">en</span>
                        <span class="inline-block bg-gray-700 text-gray-300 text-xs font-semibold mr-1 px-2 py-0.5 rounded-full">casual</span>
                        <span class="inline-block bg-gray-700 text-gray-300 text-xs font-semibold px-2 py-0.5 rounded-full">v1.2</span>
                      </div>
                      <div class="text-right mt-2">
                        <button class="text-xs text-var-primary hover:underline view-content" data-content="Remote%20Work%20Trends%3Ch1%3ERemote%20Work%20Trends%3C%2Fh1%3E%3Cp%3ERemote%20work%20is%20reshaping%20workplace%20culture...%3C%2Fp%3E" data-blogid="3" data-language="en">View</button>
                        <button class="text-xs text-var-primary hover:underline compare-versions ml-2" data-brief="Remote work culture trends">Compare</button>
                      </div>
                    </div>
                  </div>
                  <div class="history-item rounded-lg">
                    <div>
                      <p class="text-sm font-semibold text-var-text mb-1">Social media branding tips</p>
                      <div class="mb-1">
                        <span class="inline-block bg-gray-700 text-gray-300 text-xs font-semibold mr-1 px-2 py-0.5 rounded-full">ja</span>
                        <span class="inline-block bg-gray-700 text-gray-300 text-xs font-semibold mr-1 px-2 py-0.5 rounded-full">professional</span>
                        <span class="inline-block bg-gray-700 text-gray-300 text-xs font-semibold px-2 py-0.5 rounded-full">v1.0</span>
                      </div>
                      <div class="text-right mt-2">
                        <button class="text-xs text-var-primary hover:underline view-content" data-content="%E3%82%BD%E3%83%BC%E3%82%B7%E3%83%A3%E3%83%AB%E3%83%A1%E3%83%87%E3%82%A3%E3%82%A2%E3%83%96%E3%83%A9%E3%83%B3%E3%83%87%E3%82%A3%E3%83%B3%E3%82%B0%3Ch1%3E%E3%82%BD%E3%83%BC%E3%82%B7%E3%83%A3%E3%83%AB%E3%83%A1%E3%83%87%E3%82%A3%E3%82%A2%E3%83%96%E3%83%A9%E3%83%B3%E3%83%87%E3%82%A3%E3%83%B3%E3%82%B0%3C%2Fh1%3E%3Cp%3E%E3%82%BD%E3%83%BC%E3%82%B7%E3%83%A3%E3%83%AB%E3%83%81%E3%83%A3%E3%83%8D%E3%83%AB%E3%81%A7%E3%83%96%E3%83%A9%E3%83%B3%E3%83%89%E3%82%92%E6%A7%8B%E7%AF%89...%3C%2Fp%3E" data-blogid="4" data-language="ja">View</button>
                        <button class="text-xs text-var-primary hover:underline compare-versions ml-2" data-brief="Social media branding tips">Compare</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="flex-grow flex flex-col">
                <div class="flex justify-between items-center mb-4">
                  <h1 class="text-4xl font-extrabold text-var-text pt-8">📝 Forge New Content</h1>
                  <button id="toggle-history-open" class="toggle-history-btn bg-var-primary text-slate-900 px-4 py-2 rounded-lg font-semibold text-sm btn-primary md:hidden">📜 History</button>
                </div>
                <div id="chat-history" class="chat-container flex-grow p-4 flex flex-col space-y-4">
                  <div class="bot-message chat-message fade-in"><p class="p-2">Welcome to the Forge! Describe the content you need. Customize settings below.</p></div>
                </div>
              </div>
            </div>
            <div class="chat-input-area p-4 w-full">
              <div class="container mx-auto max-w-4xl">
                <form id="create-form" class="glass-card p-6 rounded-xl space-y-6">
                  <div class="flex items-start space-x-4">
                    <div class="w-full">
                      <textarea name="topic" rows="1" class="w-full rounded-lg px-4 py-3 bg-black/20 text-white border border-gray-600/50 focus:outline-none focus:ring-2 focus:ring-var-primary transition resize-none" placeholder="Enter your English brief or source text..."></textarea>
                      <div class="flex justify-between text-xs mt-1">
                        <p id="topic-error" class="text-red-400 hidden"></p>
                        <p id="word-count" class="text-var-muted">0 words</p>
                      </div>
                    </div>
                    <button type="submit" id="submit-button" class="bg-var-primary text-slate-900 p-3 rounded-lg btn-primary flex-shrink-0" title="Forge Content"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg></button>
                  </div>
                  <details open>
                    <summary class="cursor-pointer text-var-muted text-sm font-semibold">Advanced Settings</summary>
                    <div class="pt-4 space-y-6">
                      <div>
                        <label class="block font-semibold mb-2 text-sm text-var-muted">Target Language</label>
                        <div id="language-select" class="flex flex-wrap gap-2">
                          <div class="language-pill selected" data-value="en">English (en)</div>
                          <div class="language-pill" data-value="de">German (de)</div>
                          <div class="language-pill" data-value="es">Spanish (es)</div>
                          <div class="language-pill" data-value="ja">Japanese (ja)</div>
                        </div>
                        <input type="hidden" name="language" id="language-input" value="en">
                        <p id="language-error" class="text-red-400 text-xs mt-1 hidden">Please select a language.</p>
                      </div>
                      <div>
                        <label class="block font-semibold mb-2 text-sm text-var-muted">Desired Tone</label>
                        <select name="tone" class="w-full rounded-lg px-4 py-2 bg-black/20 text-white border border-gray-600/50 focus:outline-none focus:ring-1 focus:ring-var-primary transition text-sm">
                          <option value="professional">Professional</option>
                          <option value="friendly">Friendly</option>
                          <option value="casual">Casual</option>
                        </select>
                      </div>
                      <div>
                        <label class="block font-semibold mb-2 text-sm text-var-muted">Tone Intensity (1-10)</label>
                        <input type="range" name="tone_intensity" min="1" max="10" value="5" class="slider">
                        <p class="text-xs text-var-muted mt-1">Current: <span id="tone-intensity-value">5</span></p>
                      </div>
                      <div>
                        <label class="block font-semibold mb-2 text-sm text-var-muted">Target Audience</label>
                        <select name="audience" class="w-full rounded-lg px-4 py-2 bg-black/20 text-white border border-gray-600/50 focus:outline-none focus:ring-1 focus:ring-var-primary transition text-sm">
                          <option value="general">General</option>
                          <option value="technical">Technical</option>
                          <option value="business">Business</option>
                        </select>
                      </div>
                      <div>
                        <label class="block font-semibold mb-2 text-sm text-var-muted">Content Length (Words)</label>
                        <input type="range" name="word_count" min="200" max="2000" step="100" value="500" class="slider">
                        <p class="text-xs text-var-muted mt-1">Current: <span id="word-count-value">500</span> words</p>
                      </div>
                      <div>
                        <label class="block font-semibold mb-2 text-sm text-var-muted">Emphasize Keywords (comma-separated, max 5)</label>
                        <input type="text" name="keywords" class="w-full rounded-lg px-4 py-2 bg-black/20 text-white border border-gray-600/50 focus:outline-none focus:ring-1 focus:ring-var-primary transition text-sm" placeholder="e.g., AI, productivity, technology">
                        <p id="keywords-error" class="text-red-400 text-xs mt-1 hidden">Maximum 5 non-empty keywords allowed.</p>
                        <p class="text-xs text-var-muted mt-1">Enter up to 5 keywords to prioritize in content.</p>
                      </div>
                    </div>
                  </details>
                </form>
              </div>
            </div>
          </section>
        </div>

        <div id="page-inspire" class="page-content hidden">
          <section class="min-h-screen flex flex-col items-center justify-center px-6 py-24 text-center">
            <div class="container mx-auto">
              <h1 class="text-4xl md:text-5xl font-extrabold mb-4 text-var-text">Spark Your Next Idea</h1>
              <p class="text-lg text-var-muted mb-12 max-w-3xl mx-auto">Discover trending topics and keywords to fuel your content creation.</p>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="inspire-card glass-card p-6 rounded-xl text-left">
                  <h3 class="text-xl font-bold mb-2">The Future of AI in Content Creation</h3>
                  <p class="text-var-muted text-sm mb-4">Explore how AI is transforming blogging and marketing.</p>
                  <p class="text-xs text-var-muted">Keywords: AI, automation, content strategy</p>
                  <button class="mt-4 bg-var-primary text-slate-900 px-4 py-2 rounded-lg text-sm btn-primary use-topic" data-topic="The Future of AI in Content Creation">Use This Topic</button>
                </div>
                <div class="inspire-card glass-card p-6 rounded-xl text-left">
                  <h3 class="text-xl font-bold mb-2">Sustainable Business Practices in 2025</h3>
                  <p class="text-var-muted text-sm mb-4">Discuss eco-friendly strategies for modern businesses.</p>
                  <p class="text-xs text-var-muted">Keywords: sustainability, green business, corporate responsibility</p>
                  <button class="mt-4 bg-var-primary text-slate-900 px-4 py-2 rounded-lg text-sm btn-primary use-topic" data-topic="Sustainable Business Practices in 2025">Use This Topic</button>
                </div>
                <div class="inspire-card glass-card p-6 rounded-xl text-left">
                  <h3 class="text-xl font-bold mb-2">The Rise of Remote Work Culture</h3>
                  <p class="text-var-muted text-sm mb-4">Analyze trends in remote work and productivity tools.</p>
                  <p class="text-xs text-var-muted">Keywords: remote work, productivity, workplace trends</p>
                  <button class="mt-4 bg-var-primary text-slate-900 px-4 py-2 rounded-lg text-sm btn-primary use-topic" data-topic="The Rise of Remote Work Culture">Use This Topic</button>
                </div>
                <div class="inspire-card glass-card p-6 rounded-xl text-left">
                  <h3 class="text-xl font-bold mb-2">Leveraging Social Media for Brand Growth</h3>
                  <p class="text-var-muted text-sm mb-4">Strategies for engaging audiences on social platforms.</p>
                  <p class="text-xs text-var-muted">Keywords: social media, branding, digital marketing</p>
                  <button class="mt-4 bg-var-primary text-slate-900 px-4 py-2 rounded-lg text-sm btn-primary use-topic" data-topic="Leveraging Social Media for Brand Growth">Use This Topic</button>
                </div>
              </div>
            </div>
          </section>
        </div>

        <div id="page-community" class="page-content hidden">
          <section class="min-h-screen flex flex-col items-center justify-center px-6 py-24">
            <div class="container mx-auto">
              <h1 class="text-4xl md:text-5xl font-extrabold mb-4 text-var-text">Community Creations</h1>
              <p class="text-lg text-var-muted mb-12 max-w-3xl mx-auto text-center">Share your forged content and explore creations from others.</p>
              <div class="community-form glass-card p-6 rounded-xl mb-12">
                <h2 class="text-xl font-bold mb-4 text-var-text">Share Your Content</h2>
                <form id="community-post-form" class="space-y-4">
                  <div>
                    <label class="block font-semibold mb-2 text-sm text-var-muted">Title</label>
                    <input type="text" name="post-title" class="w-full rounded-lg px-4 py-2 bg-black/20 text-white border border-gray-600/50 focus:outline-none focus:ring-1 focus:ring-var-primary transition text-sm" placeholder="Enter a title for your post">
                    <p id="post-title-error" class="text-red-400 text-xs mt-1 hidden">Please enter a title.</p>
                  </div>
                  <div>
                    <label class="block font-semibold mb-2 text-sm text-var-muted">Description</label>
                    <textarea name="post-description" rows="4" class="w-full rounded-lg px-4 py-3 bg-black/20 text-white border border-gray-600/50 focus:outline-none focus:ring-1 focus:ring-var-primary transition resize-none" placeholder="Describe your content..."></textarea>
                    <p id="post-description-error" class="text-red-400 text-xs mt-1 hidden">Please enter a description.</p>
                  </div>
                  <div>
                    <label class="block font-semibold mb-2 text-sm text-var-muted">Tags (comma-separated, max 5)</label>
                    <input type="text" name="post-tags" class="w-full rounded-lg px-4 py-2 bg-black/20 text-white border border-gray-600/50 focus:outline-none focus:ring-1 focus:ring-var-primary transition text-sm" placeholder="e.g., AI, marketing, blog">
                    <p id="post-tags-error" class="text-red-400 text-xs mt-1 hidden">Maximum 5 non-empty tags allowed.</p>
                  </div>
                  <button type="submit" class="bg-var-primary text-slate-900 px-4 py-2 rounded-lg font-semibold text-sm btn-primary">Share to Community</button>
                </form>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="community-card glass-card p-6 rounded-xl text-left">
                  <h3 class="text-xl font-bold mb-2">AI-Driven Marketing Strategies</h3>
                  <p class="text-var-muted text-sm mb-4">A blog post exploring how AI can enhance digital marketing campaigns.</p>
                  <p class="text-xs text-var-muted mb-2">By: Jane Doe | Posted: Oct 15, 2025</p>
                  <p class="text-xs text-var-muted">Tags: AI, marketing, digital strategy</p>
                  <button class="mt-4 text-xs text-var-primary hover:underline view-community-post" data-content="This is a sample AI-driven marketing post...">View Post</button>
                </div>
                <div class="community-card glass-card p-6 rounded-xl text-left">
                  <h3 class="text-xl font-bold mb-2">Sustainable Tech Innovations</h3>
                  <p class="text-var-muted text-sm mb-4">An article on eco-friendly technologies shaping the future.</p>
                  <p class="text-xs text-var-muted mb-2">By: John Smith | Posted: Oct 14, 2025</p>
                  <p class="text-xs text-var-muted">Tags: sustainability, technology, innovation</p>
                  <button class="mt-4 text-xs text-var-primary hover:underline view-community-post" data-content="This is a sample sustainability post...">View Post</button>
                </div>
                <div class="community-card glass-card p-6 rounded-xl text-left">
                  <h3 class="text-xl font-bold mb-2">The Evolution of Remote Work</h3>
                  <p class="text-var-muted text-sm mb-4">Insights on how remote work is transforming workplaces.</p>
                  <p class="text-xs text-var-muted mb-2">By: Alice Brown | Posted: Oct 13, 2025</p>
                  <p class="text-xs text-var-muted">Tags: remote work, productivity, trends</p>
                  <button class="mt-4 text-xs text-var-primary hover:underline view-community-post" data-content="This is a sample remote work post...">View Post</button>
                </div>
                <div class="community-card glass-card p-6 rounded-xl text-left">
                  <h3 class="text-xl font-bold mb-2">Social Media Branding Tips</h3>
                  <p class="text-var-muted text-sm mb-4">Strategies for building a strong brand on social platforms.</p>
                  <p class="text-xs text-var-muted mb-2">By: Bob Wilson | Posted: Oct 12, 2025</p>
                  <p class="text-xs text-var-muted">Tags: social media, branding, engagement</p>
                  <button class="mt-4 text-xs text-var-primary hover:underline view-community-post" data-content="This is a sample social media post...">View Post</button>
                </div>
              </div>
            </div>
          </section>
        </div>
      </main>
    </div>
    <script>
    // 3D Scene Setup
    let scene, camera, renderer, particles, centralLight;
    const mouse = new THREE.Vector2();
    function init3D() {
        scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x0c0a09, 0.05);
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 10;
        const canvas = document.getElementById('bg-canvas');
        renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        centralLight = new THREE.PointLight(0x34d399, 2, 50);
        scene.add(centralLight);
        const particleCount = 7000;
        const particleGeometry = new THREE.BufferGeometry();
        const positions = new Float32Array(particleCount * 3);
        for(let i = 0; i < particleCount; i++) {
          positions[i*3] = (Math.random() - 0.5) * 60;
          positions[i*3+1] = (Math.random() - 0.5) * 60;
          positions[i*3+2] = (Math.random() - 0.5) * 60;
        }
        particleGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
        const particleMaterial = new THREE.PointsMaterial({ size: 0.02, vertexColors: true, transparent: true, opacity: 0.8 });
        particles = new THREE.Points(particleGeometry, particleMaterial);
        scene.add(particles);
        window.addEventListener('resize', onWindowResize, false);
        document.addEventListener('mousemove', onMouseMove, false);
        animate();
    }
    function animate() {
        requestAnimationFrame(animate);
        const time = Date.now() * 0.0005;
        particles.rotation.y = time * 0.1;
        centralLight.intensity = (Math.sin(time * 2) + 1.5) * 1.5;
        camera.position.x += (mouse.x * 2 - camera.position.x) * 0.02;
        camera.position.y += (-mouse.y * 2 - camera.position.y) * 0.02;
        camera.lookAt(scene.position);
        renderer.render(scene, camera);
    }
    function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }
    function onMouseMove(event) {
        mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
    }
    init3D();

    // Page Navigation
    const pages = document.querySelectorAll('.page-content');
    const navLinks = document.querySelectorAll('.nav-link');
    const mobileNavLinks = document.querySelectorAll('.nav-link-mobile');
    function showPage(pageId) { 
        pages.forEach(p => p.classList.toggle('hidden', `page-${pageId}` !== p.id)); 
        updateNavLinks(pageId); 
        if (pageId === 'create') {
            resetForm();
            document.getElementById('history-sidebar').classList.remove('open');
        }
        if (pageId === 'community') {
            resetCommunityForm();
        }
    }
    function updateNavLinks(activePageId) { 
        navLinks.forEach(l => l.classList.toggle('active', l.dataset.page === activePageId)); 
    }
    function handleNavClick(e) { 
        e.preventDefault(); 
        showPage(e.currentTarget.dataset.page); 
        document.getElementById('mobileMenu').classList.add('hidden'); 
    }
    navLinks.forEach(link => link.addEventListener('click', handleNavClick));
    mobileNavLinks.forEach(link => link.addEventListener('click', handleNavClick));
    showPage('home');
    document.getElementById("menuBtn").addEventListener("click", () => { 
        document.getElementById("mobileMenu").classList.toggle("hidden"); 
    });

    // Theme Toggle
    const htmlEl = document.documentElement;
    const themeToggle = document.getElementById("themeToggle");
    const sunIcon = document.getElementById("sunIcon");
    const moonIcon = document.getElementById("moonIcon");
    function updateTheme(isLight) {
        htmlEl.classList.toggle('light', isLight);
        htmlEl.classList.toggle('dark', !isLight);
        sunIcon.classList.toggle('hidden', !isLight);
        moonIcon.classList.toggle('hidden', isLight);
        if (scene && particles) {
            if (isLight) {
                scene.fog.color.setHex(0xf1f5f9);
                particles.material.color.setHex(0x475569);
                centralLight.color.setHex(0x059669);
            } else {
                scene.fog.color.setHex(0x0c0a09);
                particles.material.color.setHex(0xa1a1aa);
                centralLight.color.setHex(0x34d399);
            }
        }
    }
    const savedThemeIsLight = localStorage.getItem('theme') === 'light';
    updateTheme(savedThemeIsLight);
    themeToggle.addEventListener('click', () => {
        const isCurrentlyLight = htmlEl.classList.contains('light');
        localStorage.setItem('theme', isCurrentlyLight ? 'dark' : 'light');
        updateTheme(!isCurrentlyLight);
    });

    // Form Reset Function (Create Page)
    function resetForm() {
        const form = document.getElementById('create-form');
        form.reset();
        const languagePills = document.querySelectorAll('.language-pill');
        languagePills.forEach(p => p.classList.remove('selected'));
        document.querySelector('.language-pill[data-value="en"]').classList.add('selected');
        document.getElementById('language-input').value = 'en';
        document.getElementById('topic-error').classList.add('hidden');
        document.getElementById('language-error').classList.add('hidden');
        document.getElementById('keywords-error').classList.add('hidden');
        document.getElementById('tone-intensity-value').textContent = '5';
        document.getElementById('word-count-value').textContent = '500';
        document.getElementById('word-count').textContent = '0 words';
        const topicTextarea = form.querySelector('textarea[name="topic"]');
        topicTextarea.style.height = 'auto';
    }

    // Community Form Reset Function
    function resetCommunityForm() {
        const form = document.getElementById('community-post-form');
        form.reset();
        document.getElementById('post-title-error').classList.add('hidden');
        document.getElementById('post-description-error').classList.add('hidden');
        document.getElementById('post-tags-error').classList.add('hidden');
        const descriptionTextarea = form.querySelector('textarea[name="post-description"]');
        descriptionTextarea.style.height = 'auto';
    }

    // Language Pill Selection
    const languagePills = document.querySelectorAll('.language-pill');
    const languageInput = document.getElementById('language-input');
    const languageError = document.getElementById('language-error');
    languagePills.forEach(pill => {
        pill.addEventListener('click', () => {
            languagePills.forEach(p => p.classList.remove('selected'));
            pill.classList.add('selected');
            languageInput.value = pill.dataset.value;
            languageError.classList.add('hidden');
        });
    });

    // Slider Value Displays
    const wordCountSlider = document.querySelector('input[name="word_count"]');
    const wordCountValue = document.getElementById('word-count-value');
    wordCountValue.textContent = wordCountSlider.value;
    wordCountSlider.addEventListener('input', () => {
        wordCountValue.textContent = wordCountSlider.value;
    });

    const toneIntensitySlider = document.querySelector('input[name="tone_intensity"]');
    const toneIntensityValue = document.getElementById('tone-intensity-value');
    toneIntensityValue.textContent = toneIntensitySlider.value;
    toneIntensitySlider.addEventListener('input', () => {
        toneIntensityValue.textContent = toneIntensitySlider.value;
    });

    // Toggle History Sidebar
    const toggleHistoryOpen = document.getElementById('toggle-history-open');
    const toggleHistoryClose = document.getElementById('toggle-history');
    const historySidebar = document.getElementById('history-sidebar');
    toggleHistoryOpen.addEventListener('click', () => {
        historySidebar.classList.add('open');
        loadHistory();
    });
    toggleHistoryClose.addEventListener('click', () => {
        historySidebar.classList.remove('open');
    });

    // Chat Logic
    const createForm = document.getElementById('create-form');
    const chatHistory = document.getElementById('chat-history');
    const submitButton = document.getElementById('submit-button');
    const topicTextarea = createForm.querySelector('textarea[name="topic"]');
    const topicError = document.getElementById('topic-error');
    const wordCountDisplay = document.getElementById('word-count');
    const keywordsInput = createForm.querySelector('input[name="keywords"]');
    const keywordsError = document.getElementById('keywords-error');

    topicTextarea.addEventListener('input', () => {
        topicTextarea.style.height = 'auto';
        topicTextarea.style.height = (topicTextarea.scrollHeight) + 'px';
        const words = topicTextarea.value.trim().split(/\s+/);
        const wordCount = words[0] === '' ? 0 : words.length;
        wordCountDisplay.textContent = `${wordCount} word${wordCount === 1 ? '' : 's'}`;
    });

    function appendMessage(content, sender = 'bot') {
        const messageWrapper = document.createElement('div');
        messageWrapper.classList.add('chat-message', sender === 'user' ? 'user-message' : 'bot-message');
        const contentP = document.createElement('p');
        contentP.textContent = content;
        messageWrapper.appendChild(contentP);
        chatHistory.appendChild(messageWrapper);
        chatHistory.scrollTop = chatHistory.scrollHeight;
        return messageWrapper;
    }

    function displayForgedContent(responseData, language) {
        const { content, s3_key, blogId, quality_score, summary, error } = responseData;
        const uniqueId = `bot-response-${language}-${Date.now()}`;

        let metaInfo = '';
        if (s3_key) metaInfo += `<p class="text-xs text-white/50 mt-1">S3 Key: ${s3_key}</p>`;
        if (blogId) metaInfo += `<p class="text-xs text-white/50 mt-1">Blog ID: ${blogId}</p>`;
        metaInfo += `<p class="text-xs text-white/50 mt-1">Language: ${language}</p>`;

        const cardHtml = `
            <div class="bot-message chat-message w-full max-w-full p-0 bg-transparent lang-${language}">
                <div class="bot-response-card p-4">
                    <div class="progress-bar w-0 mb-3"></div>
                    <div class="flex justify-between items-center mb-3">
                        <div class="flex items-center space-x-2">
                           <div class="text-sm font-bold text-var-text">Forging Complete</div>
                           <div class="text-xs font-semibold px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-300">Score: ${quality_score || 0.0}%</div>
                        </div>
                        <div class="flex space-x-2">
                           <button class="text-xs text-var-primary hover:underline pause-typewriter" data-id="${uniqueId}">⏸ Pause</button>
                           <button class="text-xs text-var-primary hover:underline edit-content" data-id="${uniqueId}">Edit</button>
                           <button class="text-xs text-var-primary hover:underline save-edits hidden" data-id="${uniqueId}">Save Edits</button>
                           <button class="text-xs text-var-primary hover:underline share-community" data-id="${uniqueId}" data-content="${encodeURIComponent(content || '')}" data-summary="${encodeURIComponent(summary || '')}">Share to Community</button>
                           <button class="text-xs text-var-primary hover:underline export-pdf" data-blogid="${blogId || 'content'}">PDF</button>
                           <button class="text-xs text-var-primary hover:underline export-html" data-blogid="${blogId || 'content'}">HTML</button>
                        </div>
                    </div>
                    ${summary ? `<div class="summary-box text-sm text-var-muted"><strong>Key Points:</strong><br>${summary.replace(/\n/g, '<br>')}</div>` : ''}
                    <div class="rendered-content text-white/90 text-sm mb-4 p-3 bg-black/20 rounded overflow-hidden" style="min-height: 50px;"></div>
                    ${metaInfo ? `<div class="mt-3 pt-3 border-t border-white/10">${metaInfo}</div>` : ''}
                </div>
            </div>`;

        const cardWrapper = document.createElement('div');
        cardWrapper.id = uniqueId;
        cardWrapper.innerHTML = cardHtml;
        chatHistory.appendChild(cardWrapper);
        chatHistory.scrollTop = chatHistory.scrollHeight;

        const contentElement = cardWrapper.querySelector('.rendered-content');
        const progressBar = cardWrapper.querySelector('.progress-bar');
       
        if (error) {
            contentElement.innerHTML = `<p class="text-red-400">Error: ${error}</p>`;
            progressBar.style.width = '100%';
            progressBar.style.backgroundColor = '#ef4444';
            return;
        }

        if (content) {
            let isTyping = true;
            let animationFrameId;

            const tokens = content.match(/<[^>]+>|\S+/g) || [];
            let tokenIndex = 0;
           
            function typeToken() {
                if (!isTyping || tokenIndex >= tokens.length) {
                    contentElement.innerHTML = content;
                    progressBar.style.width = '100%';
                    const pauseBtn = cardWrapper.querySelector('.pause-typewriter');
                    if(pauseBtn) {
                        pauseBtn.textContent = 'Done';
                        pauseBtn.disabled = true;
                    }
                    return;
                }

                contentElement.innerHTML += tokens[tokenIndex] + ' ';
                tokenIndex++;
               
                progressBar.style.width = `${(tokenIndex / tokens.length) * 100}%`;
                chatHistory.scrollTop = chatHistory.scrollHeight;
               
                animationFrameId = setTimeout(typeToken, 70);
            }

            typeToken();

            const pauseButton = cardWrapper.querySelector('.pause-typewriter');
            pauseButton.addEventListener('click', () => {
                isTyping = !isTyping;
                pauseButton.textContent = isTyping ? '⏸ Pause' : '▶ Resume';
                if (isTyping) {
                    typeToken();
                } else {
                    clearTimeout(animationFrameId);
                }
            });

            const editButton = cardWrapper.querySelector('.edit-content');
            const saveButton = cardWrapper.querySelector('.save-edits');
            editButton.addEventListener('click', () => {
                isTyping = false;
                clearTimeout(animationFrameId);
                contentElement.innerHTML = content;
                progressBar.style.width = '100%';
                contentElement.contentEditable = true;
                contentElement.focus();
                saveButton.classList.remove('hidden');
                editButton.classList.add('hidden');
            });

            saveButton.addEventListener('click', () => {
                contentElement.contentEditable = false;
                saveButton.classList.add('hidden');
                editButton.classList.remove('hidden');
            });
           
            cardWrapper.querySelector('.export-pdf').addEventListener('click', (e) => {
                const blogId = e.currentTarget.dataset.blogid;
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                const source = cardWrapper.querySelector('.rendered-content');
                doc.html(source, {
                    callback: function (doc) {
                        doc.save(`${blogId}.pdf`);
                    },
                    margin: [10, 10, 10, 10],
                    autoPaging: 'text',
                    x: 0,
                    y: 0,
                    width: 190,
                    windowWidth: source.scrollWidth
                });
            });

            cardWrapper.querySelector('.export-html').addEventListener('click', (e) => {
                const blogId = e.currentTarget.dataset.blogid;
                const currentContent = cardWrapper.querySelector('.rendered-content').innerHTML;
                const htmlContent = `
                    <!DOCTYPE html>
                    <html lang="en">
                    <head>
                        <meta charset="UTF-8">
                        <title>${blogId}</title>
                        <style>
                            body { font-family: 'Inter', Arial, sans-serif; margin: 20px; line-height: 1.6; }
                            h1, h2 { color: #059669; }
                            h1 { font-size: 2rem; font-weight: 800; }
                            h2 { font-size: 1.5rem; font-weight: 700; }
                            p { margin: 1rem 0; }
                        </style>
                    </head>
                    <body>${currentContent}</body>
                    </html>`;
                const blob = new Blob([htmlContent], { type: 'text/html' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `${blogId}.html`;
                link.click();
                URL.revokeObjectURL(link.href);
            });

            cardWrapper.querySelector('.share-community').addEventListener('click', () => {
                showPage('community');
                const postTitle = document.querySelector('#community-post-form input[name="post-title"]');
                const postDescription = document.querySelector('#community-post-form textarea[name="post-description"]');
                postTitle.value = `My Forged Content (${language})`;
                postDescription.value = decodeURIComponent(summary || '') + '\n\n' + decodeURIComponent(content || '');
                postDescription.style.height = 'auto';
                postDescription.style.height = (postDescription.scrollHeight) + 'px';
            });
        } else {
            contentElement.innerHTML = `<p class="text-red-400">No content generated. Please check the API response or try again.</p>`;
            progressBar.style.width = '100%';
            progressBar.style.backgroundColor = '#ef4444';
        }
    }

    createForm.addEventListener('submit', async function(event) {
        event.preventDefault();
        const formData = new FormData(createForm);
        const data = Object.fromEntries(formData.entries());

        if (!data.topic) {
            topicError.textContent = 'Please enter a topic.';
            topicError.classList.remove('hidden');
            return;
        } else {
            topicError.classList.add('hidden');
        }
        if (!data.language) {
            languageError.textContent = 'Please select a language.';
            languageError.classList.remove('hidden');
            return;
        } else {
            languageError.classList.add('hidden');
        }
        const keywords = data.keywords ? data.keywords.split(',').map(k => k.trim()).filter(k => k) : [];
        if (keywords.length > 5) {
            keywordsError.textContent = 'Maximum 5 non-empty keywords allowed.';
            keywordsError.classList.remove('hidden');
            return;
        } else {
            keywordsError.classList.add('hidden');
            data.keywords = keywords.join(',');
        }

        appendMessage(data.topic, 'user');
        resetForm();
        submitButton.disabled = true;

        const placeholder = appendMessage('🔨 Forging content...', 'bot');

        try {
        const response = await fetch('/generate-blog', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        chatHistory.removeChild(placeholder);
        const result = await response.json();

        if (response.ok) {
          const lang = data.language;
          const contentData = result.results[lang] || { error: `No data returned for language: ${lang}` };
          
          if (contentData.error) {
              appendMessage(`⚠️ Error for ${lang}: ${contentData.error}`, 'bot');
              return;
          }

          if (contentData.s3_key && !contentData.content) {
              const fetchingMsg = appendMessage(`📦 Content stored on S3 for ${lang}. Fetching...`, 'bot');
              try {
                  const bucketRegion = 'us-east-1';
                  const s3Url = `https://agentx-blog.s3.${bucketRegion}.amazonaws.com/${contentData.s3_key}`;
                  const s3Response = await fetch(s3Url);
                  if (!s3Response.ok) throw new Error(`S3 fetch failed: ${s3Response.status}`);
                  contentData.content = await s3Response.text();
                  chatHistory.removeChild(fetchingMsg);
              } catch (s3Error) {
                  contentData.error = `Failed to fetch from S3 for ${lang}: ${s3Error.message}`;
                  chatHistory.removeChild(fetchingMsg);
              }
          }
          displayForgedContent(contentData, lang);
          // Refresh history and open sidebar after successful content generation
          historySidebar.classList.add('open');
          await loadHistory();
        } else {
           appendMessage(`⚠️ Error: ${result.error || 'An unknown error occurred.'}`, 'bot');
        }
        } catch (error) {
        chatHistory.removeChild(placeholder);
        appendMessage(`⚠️ Network Error: ${error.message}`, 'bot');
        } finally {
            submitButton.disabled = false;
        }
    });

    // Global state for history items
    let allHistoryItems = [];

    // Load History
    async function loadHistory() {
        const historyList = document.getElementById('history-list');
        const historyEmpty = document.getElementById('history-empty');
        const historyLoading = document.getElementById('history-loading');
       
        // Preserve static history items and remove only dynamic ones
        const staticItems = historyList.querySelectorAll('.history-item:not(.dynamic)');
        const dynamicItems = historyList.querySelectorAll('.history-item.dynamic');
        dynamicItems.forEach(item => item.remove());

        historyLoading.classList.remove('hidden');

        try {
            const response = await fetch('/history');
            if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
            const items = await response.json();
            allHistoryItems = items; // Store globally for comparison feature
            console.log('History fetched:', items);

            historyLoading.classList.add('hidden');

            if (!Array.isArray(items) || items.length === 0) {
                if (staticItems.length === 0) {
                    historyEmpty.classList.remove('hidden');
                } else {
                    historyEmpty.classList.add('hidden');
                }
                return;
            }

            historyEmpty.classList.add('hidden');
            const groupedByBrief = items.reduce((acc, item) => {
                acc[item.brief] = acc[item.brief] || [];
                acc[item.brief].push(item);
                return acc;
            }, {});

            for (const [brief, versions] of Object.entries(groupedByBrief)) {
                const latestVersion = versions.sort((a,b) => b.id - a.id)[0]; // Show the latest
                const historyItem = document.createElement('div');
                historyItem.classList.add('history-item', 'rounded-lg', 'dynamic');
                historyItem.innerHTML = `
                    <div>
                        <p class="text-sm font-semibold text-var-text mb-1">${brief.slice(0, 50)}${brief.length > 50 ? '...' : ''}</p>
                        <div class="mb-1">
                            <span class="inline-block bg-gray-700 text-gray-300 text-xs font-semibold mr-1 px-2 py-0.5 rounded-full">${latestVersion.language}</span>
                            <span class="inline-block bg-gray-700 text-gray-300 text-xs font-semibold mr-1 px-2 py-0.5 rounded-full">${latestVersion.tone}</span>
                            <span class="inline-block bg-gray-700 text-gray-300 text-xs font-semibold px-2 py-0.5 rounded-full">${latestVersion.version} (${versions.length} versions)</span>
                        </div>
                        <div class="text-right mt-2">
                            <button class="text-xs text-var-primary hover:underline view-content" data-content="${encodeURIComponent(latestVersion.result_text)}" data-blogid="${latestVersion.id}" data-language="${latestVersion.language}">View Latest</button>
                            <button class="text-xs text-var-primary hover:underline compare-versions ml-2" data-brief="${encodeURIComponent(brief)}">Compare</button>
                        </div>
                    </div>`;
                historyList.appendChild(historyItem);
            }
        } catch (error) {
            console.error('Failed to load history:', error);
            historyLoading.classList.add('hidden');
            historyList.innerHTML += `<p class="text-red-400 p-4">Error loading history.</p>`;
        }
    }

    // Modal helper function
    function createModal(contentHtml, title = 'Details') {
        const modalOverlay = document.createElement('div');
        modalOverlay.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[100] p-4 fade-in';
        modalOverlay.innerHTML = `
            <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-6xl max-h-[90vh] flex flex-col glass-card">
                <div class="p-4 border-b border-[rgba(55,65,81,0.5)] flex justify-between items-center">
                    <h2 class="text-xl font-bold text-var-primary">${title}</h2>
                    <button class="text-2xl text-var-muted hover:text-var-primary">&times;</button>
                </div>
                <div class="p-6 overflow-y-auto">
                    ${contentHtml}
                </div>
            </div>
        `;
        document.body.appendChild(modalOverlay);
        const closeModal = () => document.body.removeChild(modalOverlay);
        modalOverlay.querySelector('button').addEventListener('click', closeModal);
        modalOverlay.addEventListener('click', (e) => {
            if (e.target === modalOverlay) closeModal();
        });
    }

    // History Sidebar Event Delegation
    document.getElementById('history-list').addEventListener('click', (e) => {
        const target = e.target;
        if (target.classList.contains('view-content')) {
            e.preventDefault();
            const content = decodeURIComponent(target.dataset.content);
            const blogId = target.dataset.blogid;
            const language = target.dataset.language || 'en';

            chatHistory.innerHTML = ''; // Clear chat completely
            appendMessage("Loaded from Archives. You can edit, export, or share below.", 'bot');
            
            displayForgedContent({
                content: content,
                blogId: `archive-${blogId}`,
                quality_score: 'N/A',
                summary: 'This content was loaded from your archives.'
            }, language);

            historySidebar.classList.remove('open');
            showPage('create');
        } else if (target.classList.contains('compare-versions')) {
            e.preventDefault();
            const brief = decodeURIComponent(target.dataset.brief);
            const versionsToCompare = allHistoryItems.filter(item => item.brief === brief);

            if (versionsToCompare.length > 0) {
                const comparisonHtml = `
                    <div class="grid grid-cols-1 md:grid-cols-${Math.min(3, versionsToCompare.length)} gap-4">
                        ${versionsToCompare.map(v => `
                            <div class="border border-gray-700 rounded-lg p-4 bg-black/20">
                                <div class="flex justify-between items-center mb-2 pb-2 border-b border-gray-700">
                                    <span class="font-bold text-var-text">${v.version || 'v?.?'}</span>
                                    <span class="text-xs bg-gray-700 text-gray-300 px-2 py-0.5 rounded-full">${v.tone || 'unknown'}</span>
                                </div>
                                <div class="rendered-content text-sm max-h-96 overflow-y-auto">${v.result_text || 'No content available.'}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
                createModal(comparisonHtml, `Comparing: ${brief}`);
            } else {
                alert('Could not find versions to compare.');
            }
        }
    });

    // Inspire Page Logic
    document.getElementById('page-inspire').addEventListener('click', (e) => {
        if (e.target.classList.contains('use-topic')) {
            const topic = e.target.dataset.topic;
            showPage('create');
            const topicTextarea = document.querySelector('#create-form textarea[name="topic"]');
            topicTextarea.value = topic;
            topicTextarea.dispatchEvent(new Event('input', { bubbles: true })); // Trigger auto-resize and word count
            topicTextarea.focus();
        }
    });

    // Community Page Logic
    const communityForm = document.getElementById('community-post-form');
    communityForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const titleInput = communityForm.querySelector('input[name="post-title"]');
        const descriptionInput = communityForm.querySelector('textarea[name="post-description"]');
        const tagsInput = communityForm.querySelector('input[name="post-tags"]');
        
        const titleError = document.getElementById('post-title-error');
        const descriptionError = document.getElementById('post-description-error');
        const tagsError = document.getElementById('post-tags-error');

        let isValid = true;
        
        if (!titleInput.value.trim()) { titleError.classList.remove('hidden'); isValid = false; } else { titleError.classList.add('hidden'); }
        if (!descriptionInput.value.trim()) { descriptionError.classList.remove('hidden'); isValid = false; } else { descriptionError.classList.add('hidden'); }
        
        const tags = tagsInput.value.split(',').map(t => t.trim()).filter(t => t);
        if (tags.length > 5) { tagsError.classList.remove('hidden'); isValid = false; } else { tagsError.classList.add('hidden'); }

        if (isValid) {
            const communityGrid = document.querySelector('#page-community .grid');
            const newPost = document.createElement('div');
            newPost.className = 'community-card glass-card p-6 rounded-xl text-left fade-in';
            newPost.innerHTML = `
                <h3 class="text-xl font-bold mb-2">${titleInput.value}</h3>
                <p class="text-var-muted text-sm mb-4">${descriptionInput.value.slice(0, 100)}...</p>
                <p class="text-xs text-var-muted mb-2">By: You | Posted: Just Now</p>
                <p class="text-xs text-var-muted">Tags: ${tags.join(', ')}</p>
                <button class="mt-4 text-xs text-var-primary hover:underline view-community-post" data-title="${encodeURIComponent(titleInput.value)}" data-content="${encodeURIComponent(descriptionInput.value)}">View Post</button>
            `;
            communityGrid.insertBefore(newPost, communityGrid.children[0]);
            resetCommunityForm();
            appendMessage("Successfully shared to the community!", 'bot');
        }
    });

    document.getElementById('page-community').addEventListener('click', (e) => {
        if (e.target.classList.contains('view-community-post')) {
            const title = decodeURIComponent(e.target.dataset.title);
            const content = decodeURIComponent(e.target.dataset.content);
            const modalContent = `<div class="prose prose-invert max-w-none text-var-text">${content.replace(/\n/g, '<br>')}</div>`;
            createModal(modalContent, title);
        }
    });
    </script>
  </body>
</html>
